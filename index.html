<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gerador de Token - Sala (demo)</title>
  <style>
    body{font-family:Arial,Helvetica,sans-serif;margin:24px}
    input,textarea{width:100%;padding:8px;margin:6px 0}
    button{padding:8px 12px;cursor:pointer}
    pre{background:#f5f5f5;padding:12px;white-space:pre-wrap;word-break:break-word}
  </style>
</head>
<body>
  <h1>Gerador e Validador de Token (Demo em HTML único)</h1>

  <h2>Gerar token (admin)</h2>
  <label>Senha admin: <input id="pass" type="password"></label>
  <label>Room ID: <input id="room"></label>
  <label>Candidate ID (opcional): <input id="cand"></label>
  <button id="gen">Gerar token</button>
  <h4>Resultado</h4>
  <pre id="result">—</pre>

  <hr>
  <h2>Validar token</h2>
  <textarea id="tokenInput" rows="3"></textarea>
  <button id="validate">Validar</button>
  <pre id="validationResult">—</pre>

  <!-- Biblioteca JWT em JS puro -->
  <script src="https://cdn.jsdelivr.net/npm/jsrsasign"></script>
  <script>
  // Configurações (NÃO usar em produção)
  const ADMIN_PASSWORD = "123456"; // altere
  const JWT_SECRET = "segredo_super_forte"; // altere
  const TOKEN_TTL_SECONDS = 900; // 15min

  // Função para gerar JWT (HS256)
  function generateJWT(payload, secret, ttlSec){
    const header = {alg:"HS256",typ:"JWT"};
    const now = Math.floor(Date.now()/1000);
    const fullPayload = {...payload, iat: now, exp: now + ttlSec};
    return KJUR.jws.JWS.sign("HS256", JSON.stringify(header), JSON.stringify(fullPayload), {utf8: secret});
  }

  // Função para validar JWT
  function validateJWT(token, secret){
    try{
      const isValid = KJUR.jws.JWS.verifyJWT(token, {utf8: secret}, {alg: ["HS256"]});
      if(!isValid) return {valid:false,error:"Assinatura inválida"};
      const payloadObj = KJUR.jws.JWS.readSafeJSONString(b64utoutf8(token.split(".")[1]));
      const now = Math.floor(Date.now()/1000);
      if(payloadObj.exp && now > payloadObj.exp) return {valid:false,error:"Token expirado"};
      return {valid:true,payload:payloadObj};
    }catch(e){
      return {valid:false,error:e.message};
    }
  }

  // Eventos
  document.getElementById('gen').onclick = () => {
    const password = document.getElementById('pass').value;
    const room = document.getElementById('room').value;
    const cand = document.getElementById('cand').value;
    if(password !== ADMIN_PASSWORD){
      document.getElementById('result').textContent = "Erro: senha admin incorreta";
      return;
    }
    if(!room){
      document.getElementById('result').textContent = "Erro: roomId obrigatório";
      return;
    }
    const token = generateJWT({room, candidate:cand||null}, JWT_SECRET, TOKEN_TTL_SECONDS);
    document.getElementById('result').textContent = token;
  };

  document.getElementById('validate').onclick = () => {
    const token = document.getElementById('tokenInput').value.trim();
    const result = validateJWT(token, JWT_SECRET);
    document.getElementById('validationResult').textContent = JSON.stringify(result,null,2);
  };
  </script>
</body>
</html>
